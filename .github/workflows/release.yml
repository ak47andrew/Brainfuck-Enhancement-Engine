name: Release CLI Tool

on:
  push:
    tags:
      - 'v*' # Trigger a release on any tag starting with 'v'
  pull_request:
    branches: [ main ]

jobs:
# TODO: readd when there will be something to actually test
#  test:
#    name: Test on Python ${{ matrix.python-version }}
#    runs-on: ubuntu-latest
#    strategy:
#      matrix:
#        python-version: ['3.9', '3.10', '3.11'] # Test multiple Python versions
#
#    steps:
#    - uses: actions/checkout@v4
#    - name: Set up Python ${{ matrix.python-version }}
#      uses: actions/setup-python@v4
#      with:
#        python-version: ${{ matrix.python-version }}
#    - name: Install dependencies
#      run: |
#        python -m pip install --upgrade pip
#        pip install -r requirements.txt
#        # If you use pytest:
#        pip install pytest
#    - name: Run tests
#      run: |
#        # Replace this with your test command, e.g.:
#        python -m pytest

  build-and-release:
    name: Build Binary and Create Release
    # This job only runs on tag pushes, not pull requests
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ${{ matrix.os }}
    # needs: test # Ensure tests pass before building

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.14"

    - name: Install dependencies and PyInstaller
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller

    - name: Build the binary with PyInstaller
      run: |
        pyinstaller --onefile src/hive/__main__.py -n bee

    - name: Create GitHub Release & Upload Asset
      uses: softprops/action-gh-release@v1
      with:
        # This will use the tag name as the release title
        tag_name: ${{ github.ref }}
        # This will generate release notes automatically based on your commits
        generate_release_notes: true
        # This will attach the binary you built
        files: |
          dist/bee
      env:
        # This token is provided automatically by GitHub Actions
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}